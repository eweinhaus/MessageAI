graph TB
    subgraph "Client Layer - React Native + Expo"
        UA["ğŸ‘¤ User A's Phone<br/>React Native App"]
        UB["ğŸ‘¤ User B's Phone<br/>React Native App"]
        
        subgraph "User A - App Components"
            UAComp["ğŸ¨ UI Components<br/>â€¢ Chat Screen<br/>â€¢ Message List<br/>â€¢ Contact Picker<br/>â€¢ Auth Screens<br/>â€¢ Chat List"]
            UAState["ğŸ“¦ Zustand State<br/>â€¢ Current User<br/>â€¢ Active Chats<br/>â€¢ Messages by Chat<br/>â€¢ Network Status<br/>â€¢ Sync Queue"]
            UASQL["ğŸ’¾ SQLite Database<br/>â€¢ Messages (with syncStatus)<br/>â€¢ Chat Metadata<br/>â€¢ Pending Queue<br/>â€¢ Last Sync Timestamp"]
            UANotif["ğŸ”” Expo Notifications<br/>â€¢ FCM Receiver<br/>â€¢ In-App Toast Handler<br/>â€¢ Foreground Only"]
            UANet["ğŸ“¡ NetInfo Listener<br/>â€¢ Network Status<br/>â€¢ Online/Offline Detection<br/>â€¢ Auto-Reconnect Trigger"]
        end
        
        subgraph "User B - App Components"
            UBComp["ğŸ¨ UI Components<br/>â€¢ Chat Screen<br/>â€¢ Message List<br/>â€¢ Contact Picker<br/>â€¢ Auth Screens<br/>â€¢ Chat List"]
            UBState["ğŸ“¦ Zustand State<br/>â€¢ Current User<br/>â€¢ Active Chats<br/>â€¢ Messages by Chat<br/>â€¢ Network Status<br/>â€¢ Sync Queue"]
            UBSQL["ğŸ’¾ SQLite Database<br/>â€¢ Messages (with syncStatus)<br/>â€¢ Chat Metadata<br/>â€¢ Pending Queue<br/>â€¢ Last Sync Timestamp"]
            UBNotif["ğŸ”” Expo Notifications<br/>â€¢ FCM Receiver<br/>â€¢ In-App Toast Handler<br/>â€¢ Foreground Only"]
            UBNet["ğŸ“¡ NetInfo Listener<br/>â€¢ Network Status<br/>â€¢ Online/Offline Detection<br/>â€¢ Auto-Reconnect Trigger"]
        end
        
        UA --> UAComp
        UA --> UAState
        UA --> UASQL
        UA --> UANotif
        UA --> UANet
        
        UB --> UBComp
        UB --> UBState
        UB --> UBSQL
        UB --> UBNotif
        UB --> UBNet
    end
    
    subgraph "Real-Time Listeners - Firestore SDK"
        ListenerA["ğŸ“¡ Firestore Listener A<br/>onSnapshot: /chats where<br/>participantIDs contains userA"]
        ListenerB["ğŸ“¡ Firestore Listener B<br/>onSnapshot: /chats where<br/>participantIDs contains userB"]
        
        PresenceA["ğŸ“¡ Presence Listener A<br/>onSnapshot: /users/{userB}<br/>Field: isOnline"]
        PresenceB["ğŸ“¡ Presence Listener B<br/>onSnapshot: /users/{userA}<br/>Field: isOnline"]
        
        MsgListenerA["ğŸ“¡ Message Listener A<br/>onSnapshot: /chats/{chatID}<br/>/messages orderBy timestamp"]
        MsgListenerB["ğŸ“¡ Message Listener B<br/>onSnapshot: /chats/{chatID}<br/>/messages orderBy timestamp"]
    end
    
    subgraph "Cloud Layer - Firebase"
        AUTH["ğŸ” Firebase Auth<br/>â€¢ Google Sign-In<br/>â€¢ Session Management<br/>â€¢ Token Auto-Refresh<br/>â€¢ onAuthStateChanged"]
        
        FS["â˜ï¸ Firestore<br/>(Source of Truth)<br/><br/>Collections:<br/>â€¢ /users<br/>â€¢ /chats<br/>â€¢ /chats/{id}/messages"]
        
        CF["âš¡ Cloud Functions<br/><br/>onMessageCreated:<br/>â€¢ Check recipient online<br/>â€¢ Get FCM token<br/>â€¢ Send push (foreground)<br/><br/>Scheduled:<br/>â€¢ Clean old presence data"]
        
        FCM["ğŸ“¢ Firebase Cloud<br/>Messaging (FCM)<br/>â€¢ Push to Device A<br/>â€¢ Push to Device B<br/>â€¢ Foreground Only"]
    end
    
    subgraph "Data Flow: Send Message"
        SEND["1ï¸âƒ£ User A types 'Hello'<br/>2ï¸âƒ£ Tap Send<br/>3ï¸âƒ£ Write to SQLite immediately<br/>   (syncStatus: pending)<br/>4ï¸âƒ£ Show in UI (optimistic)<br/>5ï¸âƒ£ Async: Write to Firestore<br/>6ï¸âƒ£ On success: Update SQLite<br/>   (syncStatus: synced)<br/>7ï¸âƒ£ Update UI (sent âœ“)"]
    end
    
    subgraph "Data Flow: Receive Message"
        RECEIVE["1ï¸âƒ£ Firestore message created<br/>2ï¸âƒ£ Listener B fires<br/>3ï¸âƒ£ Write to SQLite<br/>4ï¸âƒ£ Update Zustand state<br/>5ï¸âƒ£ UI re-renders (new message)<br/>6ï¸âƒ£ CF sends FCM notification<br/>7ï¸âƒ£ User B sees in-app toast<br/>8ï¸âƒ£ User B views message<br/>9ï¸âƒ£ Update readBy in Firestore<br/>ğŸ”Ÿ Listener A fires â†’ read receipt"]
    end
    
    subgraph "Data Flow: Offline â†’ Online"
        OFFLINE["1ï¸âƒ£ User A offline (airplane mode)<br/>2ï¸âƒ£ Types 'Are you free?'<br/>3ï¸âƒ£ Tap Send<br/>4ï¸âƒ£ Write to SQLite (pending)<br/>5ï¸âƒ£ Show 'Offline' banner<br/>6ï¸âƒ£ NetInfo detects online<br/>7ï¸âƒ£ Hide banner<br/>8ï¸âƒ£ Process pending queue:<br/>   - Query SQLite for pending<br/>   - Retry with backoff (1s, 2s, 4s...)<br/>   - Max 5 attempts<br/>9ï¸âƒ£ On success: Update to synced<br/>ğŸ”Ÿ Normal flow resumes"]
    end
    
    subgraph "Data Flow: Presence"
        PRESENCE["1ï¸âƒ£ App foreground:<br/>   - setUserOnline(userID)<br/>   - Write to /users/{id}<br/>   - Set onDisconnect() handler<br/>2ï¸âƒ£ App background:<br/>   - onDisconnect triggers<br/>   - Sets isOnline: false<br/>3ï¸âƒ£ Listener fires<br/>4ï¸âƒ£ UI updates (gray dot)<br/><br/>Throttle: Max 1 write per 30s"]
    end
    
    subgraph "Sync Strategy"
        SYNC["SQLite = Read Cache + Write Queue<br/>Firestore = Source of Truth<br/><br/>On Startup:<br/>1. Read SQLite (instant UI)<br/>2. Async sync with Firestore<br/>3. Reconcile differences<br/><br/>On Conflict:<br/>â€¢ Firestore ALWAYS wins<br/>â€¢ Overwrite SQLite<br/><br/>On Send:<br/>1. Write SQLite (pending)<br/>2. Write Firestore (async)<br/>3. Update SQLite (synced)<br/><br/>On Receive:<br/>1. Listener fires<br/>2. Write SQLite<br/>3. Update UI"]
    end
    
    %% Connections - User A Flow
    UAComp -->|User Action: Send| UAState
    UAState -->|Optimistic Write| UASQL
    UASQL -->|Queue Processor| FS
    UANet -->|Network Status| UAState
    
    %% Connections - User B Flow
    UBComp -->|View Message| UBState
    UBState -->|Mark Read| FS
    UBNet -->|Network Status| UBState
    
    %% Connections - Real-Time Sync
    FS -->|Real-Time Updates| ListenerA
    FS -->|Real-Time Updates| ListenerB
    FS -->|Real-Time Updates| MsgListenerA
    FS -->|Real-Time Updates| MsgListenerB
    FS -->|Real-Time Updates| PresenceA
    FS -->|Real-Time Updates| PresenceB
    
    ListenerA -->|New Chat Data| UAState
    ListenerB -->|New Chat Data| UBState
    MsgListenerA -->|New Messages| UAState
    MsgListenerB -->|New Messages| UBState
    PresenceA -->|Status Update| UAComp
    PresenceB -->|Status Update| UBComp
    
    UAState -->|Write on Receive| UASQL
    UBState -->|Write on Receive| UBSQL
    
    %% Connections - Push Notifications
    FS -->|onCreate Message| CF
    CF -->|Send Notification| FCM
    FCM -->|Foreground Push| UANotif
    FCM -->|Foreground Push| UBNotif
    UANotif -->|Display Toast| UAComp
    UBNotif -->|Display Toast| UBComp
    
    %% Connections - Auth
    AUTH -->|Validate & Refresh| FS
    AUTH -->|Token Management| UAState
    AUTH -->|Token Management| UBState
    
    %% Network Detection
    UANet -->|Reconnect Event| UASQL
    UBNet -->|Reconnect Event| UBSQL
    
    %% Styling
    classDef client fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef firebase fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef listener fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef flow fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef sync fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    
    class UA,UB,UAComp,UAState,UASQL,UANotif,UANet,UBComp,UBState,UBSQL,UBNotif,UBNet client
    class FS,AUTH,CF,FCM firebase
    class ListenerA,ListenerB,PresenceA,PresenceB,MsgListenerA,MsgListenerB listener
    class SEND,RECEIVE,OFFLINE,PRESENCE flow
    class SYNC sync
